---
title: é‡å­¦webpack(ä¸€) -- åŒæºç­–ç•¥
date: '2023-10-1'
tags: ['webpack']
draft: false
summary: 'é‡å­¦webpack ç¬¬ 1 éƒ¨åˆ† -- Same-origin policy'
authors: ['default']
---

import TOCInline from 'pliny/ui/TOCInline'

<TOCInline toc={props.toc} exclude="Overview" toHeading={3} />

## åŒæºç­–ç•¥æ˜¯ä»€ä¹ˆ

**åŒæºç­–ç•¥**æ˜¯ä¸€ä¸ªé‡è¦çš„`å®‰å…¨ç­–ç•¥`ï¼Œå®ƒç”¨äºé™åˆ¶ä¸€ä¸ªæºçš„æ–‡æ¡£æˆ–è€…å®ƒåŠ è½½çš„è„šæœ¬å¦‚ä½•èƒ½ä¸å¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ã€‚

å®ƒèƒ½å¸®åŠ©é˜»éš”æ¶æ„æ–‡æ¡£ï¼Œå‡å°‘å¯èƒ½è¢«æ”»å‡»çš„åª’ä»‹ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥é˜²æ­¢äº’è”ç½‘ä¸Šçš„æ¶æ„ç½‘ç«™åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ JS è„šæœ¬ï¼Œä»ç¬¬ä¸‰æ–¹ç½‘ç»œé‚®ä»¶æœåŠ¡(ç”¨æˆ·å·²ç™»å½•)æˆ–å…¬å¸å†…ç½‘(å› æ²¡æœ‰å…¬å…± IP åœ°å€è€Œå—åˆ°ä¿æŠ¤ï¼Œä¸ä¼šè¢«æ”»å‡»è€…ç›´æ¥è®¿é—®)è¯»å–æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®è½¬å‘ç»™æ”»å‡»è€…ã€‚

åˆä»æŠ€æœ¯å‘å±•å±‚é¢æ¥è¯´ï¼ŒåŒæºç­–ç•¥å…¶å®æ˜¯`å‰åç«¯åˆ†ç¦»æ¨¡å¼`å‡ºç°çš„äº§ç‰©ï¼Œå› ä¸ºå³ä½¿åœ¨ç°åœ¨çš„å¼€å‘è¿‡ç¨‹ï¼ŒæœåŠ¡ç«¯ä¹‹é—´çš„èµ„æºä¼ é€’ã€è¯·æ±‚ç­‰æ˜¯æ²¡æœ‰è·¨åŸŸé—®é¢˜çš„ï¼Œæ‰€ä»¥åŒæºç­–ç•¥ä¸»è¦æ˜¯æµè§ˆå™¨å±‚é¢åšå‡ºçš„å®‰å…¨æªæ–½

### æºçš„å®šä¹‰

å¦‚æœä¸¤ä¸ª `URL` çš„[åè®®](https://developer.mozilla.org/zh-CN/docs/Glossary/Protocol)ã€[ç«¯å£](https://developer.mozilla.org/zh-CN/docs/Glossary/Port)(å¦‚æœæœ‰æŒ‡å®šçš„è¯)å’Œ[ä¸»æœº](https://developer.mozilla.org/zh-CN/docs/Glossary/Host)éƒ½ç›¸åŒçš„è¯ï¼Œåˆ™è¿™ä¸¤ä¸ª URL æ˜¯åŒæºçš„ã€‚è¿™ä¸ªæ–¹æ¡ˆä¹Ÿè¢«ç§°ä¸º`â€œåè®®/ä¸»æœº/ç«¯å£å…ƒç»„â€`ï¼Œæˆ–è€…ç›´æ¥æ˜¯`â€œå…ƒç»„â€`ã€‚(â€œå…ƒç»„â€æ˜¯æŒ‡ä¸€ç»„é¡¹ç›®æ„æˆçš„æ•´ä½“ï¼Œå…·æœ‰åŒé‡/ä¸‰é‡/å››é‡/äº”é‡ç­‰é€šç”¨å½¢å¼ã€‚)

ä¸‹è¡¨ç»™å‡ºäº†ä¸ URL `http://store.company.com/dir/page.html` çš„æºè¿›è¡Œå¯¹æ¯”çš„ç¤ºä¾‹ï¼š

| URL                                               | ç»“æœ | åŸå›                               |
| ------------------------------------------------- | ---- | --------------------------------- |
| `http://store.company.com/dir2/other.html`        | åŒæº | åªæœ‰è·¯å¾„ä¸åŒ                      |
| `http://store.company.com/dir/inner/another.html` | åŒæº | åªæœ‰è·¯å¾„ä¸åŒ                      |
| `https://store.company.com/secure.html`           | å¤±è´¥ | åè®®ä¸åŒ                          |
| `http://store.company.com:81/dir/etc.html`        | å¤±è´¥ | ç«¯å£ä¸åŒ(`http://` é»˜è®¤ç«¯å£æ˜¯ 80) |
| `http://news.company.com/dir/other.html`          | å¤±è´¥ | ä¸»æœºä¸åŒ                          |

### æºçš„ç»§æ‰¿

åœ¨é¡µé¢ä¸­é€šè¿‡ `about:blank` æˆ– `javascript:` URL æ‰§è¡Œçš„è„šæœ¬ä¼šç»§æ‰¿æ‰“å¼€è¯¥ URL çš„æ–‡æ¡£çš„æºï¼Œå› ä¸ºè¿™äº›ç±»å‹çš„ URL æ²¡æœ‰åŒ…å«æºæœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯ã€‚

## è·¨æºç½‘ç»œè®¿é—®

'åŒæºç­–ç•¥æ§åˆ¶ä¸åŒæºä¹‹é—´çš„äº¤äº’ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨ [XMLHttpRequest](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest) æˆ– [img](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/img) æ ‡ç­¾æ—¶åˆ™ä¼šå—åˆ°åŒæºç­–ç•¥çš„çº¦æŸã€‚è¿™äº›äº¤äº’é€šå¸¸åˆ†ä¸ºä¸‰ç±»ï¼š

- **è·¨æºå†™æ“ä½œ**(Cross-origin writes)ä¸€èˆ¬æ˜¯è¢«å…è®¸çš„ã€‚ä¾‹å¦‚é“¾æ¥ã€é‡å®šå‘ä»¥åŠè¡¨å•æäº¤ã€‚ç‰¹å®šå°‘æ•°çš„ HTTP è¯·æ±‚éœ€è¦æ·»åŠ [é¢„æ£€è¯·æ±‚](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS#%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82)ã€‚
- **è·¨æºèµ„æºåµŒå…¥**(Cross-origin embedding)ä¸€èˆ¬æ˜¯è¢«å…è®¸çš„ã€‚
- **è·¨æºè¯»æ“ä½œ**(Cross-origin reads)ä¸€èˆ¬æ˜¯ä¸è¢«å…è®¸çš„ï¼Œä½†å¸¸å¯ä»¥é€šè¿‡å†…åµŒèµ„æºæ¥å·§å¦™çš„è¿›è¡Œè¯»å–è®¿é—®ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¯»å–åµŒå…¥å›¾ç‰‡çš„é«˜åº¦å’Œå®½åº¦ï¼Œè°ƒç”¨å†…åµŒè„šæœ¬çš„æ–¹æ³•ï¼Œæˆ–[å¾—çŸ¥å†…åµŒèµ„æºçš„å¯ç”¨æ€§](https://bugzilla.mozilla.org/show_bug.cgi?id=629094)

## å¦‚ä½•å…è®¸è·¨åŸŸè®¿é—®

å¯ä»¥ä½¿ç”¨ [CORS](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS) æ¥å…è®¸è·¨æºè®¿é—®ã€‚`CORS` æ˜¯ `HTTP` çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…è®¸æœåŠ¡ç«¯æ¥æŒ‡å®šå“ªäº›ä¸»æœºå¯ä»¥ä»è¿™ä¸ªæœåŠ¡ç«¯åŠ è½½èµ„æºã€‚

## å…·ä½“ä»£ç 

### å‡†å¤‡å·¥ä½œ

#### å…ˆåˆ›å»ºé¡¹ç›®`webpack-same-origin`

#### ç„¶ååœ¨æ ¹ç›®å½•åˆ›å»º `src` æ–‡ä»¶å¤¹ ğŸ“

`pnpm init && pnpm i koa @koa/router` ä¸ºå¯åŠ¨æœåŠ¡åšå‡†å¤‡

### æœåŠ¡ç«¯ä»£ç 

```js:index.js
const koa = require('koa')
const koaRouter = require('@koa/router')

const app = new koa()
const router = new koaRouter()

router.get('/list', (ctx, next) => {
  ctx.body = [{ id: 111, name: 'aimyon' }]
})

app.use(router.routes())
app.use(router.allowedMethods())

app.listen(8000, () => {
  console.log('server on http://localhost:8000')
})
```

#### ç„¶ååœ¨æ ¹ç›®å½•åˆ›å»º `dist` æ–‡ä»¶å¤¹ ğŸ“ï¼Œä»¥åŠ `index.html` æ–‡ä»¶

```html:index.html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
  </head>
  <body>
    <script>
      //   1. XHR
      const xhr = new XMLHttpRequest()
      xhr.onreadystatechange = () => {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          console.log(xhr.responseText)
        }
      }
      xhr.open('get', 'http://localhost:8000/list')
      xhr.send()

      //   2.fetch
      // fetch('http://localhost:8000/list').then(async (res) => {
      //   const result = await res.json()
      //   console.log('fetch>>>', result)
      // })
    </script>
  </body>
</html>
```

ç„¶åæ­¤æ—¶å¯åŠ¨æœåŠ¡ï¼Œæ‰“å¼€ `index.html` æ–‡ä»¶ï¼Œä¼šå‘ç°æ§åˆ¶å°æŠ¥é”™ `Access to XMLHttpRequest at 'http://localhost:8000/' from origin 'null' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.`
æˆ–è€…ä½¿ç”¨ `fetch` æ—¶ï¼Œä¼šæŠ¥é”™ `Access to fetch at 'http://localhost:8000/' from origin 'null' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.`

#### è¿™å°±æ˜¯åŒæºç­–ç•¥çš„é™åˆ¶ ğŸš«

## è§£å†³åŠæ³•(å®é™…åœºæ™¯ä¸‹æ‰€æœ‰æ–¹æ³•åŸºæœ¬éƒ½æ˜¯æœåŠ¡ç«¯è§£å†³)

1. æœåŠ¡ç«¯è®¾ç½® `Access-Control-Allow-Origin` å¤´éƒ¨(`CORS`)

   ```js:index.js
   const koa = require('koa')
   const koaRouter = require('@koa/router')
   const koaStatic = require('koa-static')

   const app = new koa()

   // app.use(koaStatic('./client'))

   const router = new koaRouter()

   router.get('/list', (ctx, _next) => {
     // åªæœ‰ç®€å•è¯·æ±‚(HEAD,GET,POST)å¯ä»¥åªè¿™ä¹ˆå†™
     ctx.set('Access-Control-Allow-Origin', '*')
     // æœ‰éç®€å•è¯·æ±‚
     ctx.set('Access-Control-Allow-Origin', '*')
     // ä¸º cookie å‡†å¤‡
     ctx.set('Access-Control-Allow-Credentials', true)
     ctx.set('Access-Control-Allow-Methods', 'GET, POST, PUT, PATCH, DELETE, OPTIONS')
     ctx.set(
       'Access-Control-Allow-Headers',
       'Accept,Accept-Encoding,Accept-Language,Connection,Content-Length,Content-Type,Host,Origin,Referer,User-Agent'
     )
     ctx.body = [{ id: 111, name: 'aimyon' }]
   })

   app.use(router.routes())
   app.use(router.allowedMethods())

   app.listen(8000, () => {
     console.log('server on http://localhost:8000')
   })
   ```

2. æœ€ç»ˆçº¿ä¸Šé¡¹ç›®ä¸€èˆ¬éƒ½æ˜¯ç”¨ `Nginx åå‘ä»£ç†`

3. å°†é™æ€èµ„æºå’Œ API æœåŠ¡å™¨éƒ¨ç½²åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¾‹å¦‚å°† `index.html` ä½œä¸ºé™æ€èµ„æºéƒ¨ç½²åˆ°æœåŠ¡ç«¯, `pnpm i koa-static`

   ```js:index.js
   const koa = require('koa')
   const koaRouter = require('@koa/router')
   const koaStatic = require('koa-static')

   const app = new koa()

   app.use(koaStatic('./client'))

   const router = new koaRouter()

   router.get('/list', (ctx, _next) => {
     ctx.body = [{ id: 111, name: 'aimyon' }]
   })

   app.use(router.routes())
   app.use(router.allowedMethods())

   app.listen(8000, () => {
     console.log('server on http://localhost:8000/list')
   })
   ```

4. ä½¿ç”¨ `webpack-dev-server` ä»£ç†(æœ¬è´¨å°±æ˜¯å¼€ä¸€ä¸ª node æœåŠ¡ï¼Œç„¶åé€šè¿‡ `http-proxy-middleware` ä¸­é—´ä»¶ä»£ç†è¯·æ±‚)

   ```js:webpack.config.js
   module.exports = {
     devServer: {
       proxy: {
         '/api': {
           target: 'http://localhost:8000',
           pathRewrite: { '^/api': '' },
           changeOrigin: true,
         },
       },
     },
   }
   ```

   ```js:index.html
   fetch('/api/list').then(async (res) => {
     const result = await res.json()
     console.log('fetch>>>', result)
   })
   ```

5. ä½¿ç”¨ `webpack-dev-server` çš„ `before` é…ç½®

   ```js:webpack.config.js
   module.exports = {
     devServer: {
       before: (app) => {
         app.get('/api/list', (req, res) => {
           res.json([{ id: 111, name: 'aimyon' }])
         })
       },
     },
   }
   ```

6. ä½¿ç”¨ `webpack-dev-server` çš„ `after` é…ç½®

   ```js:webpack.config.js
   module.exports = {
     devServer: {
       after: (app) => {
         app.get('/api/list', (req, res) => {
           res.json([{ id: 111, name: 'aimyon' }])
         })
       },
     },
   }
   ```

7. å¦å¤–è¿˜æœ‰ `window.postMessage`(ä¸è¿‡ä¸å¸¸ç”¨ï¼Œä½†æ˜¯ `MDN` å®˜ç½‘æœ‰æåˆ°ï¼Œè¿™å°±æ˜¯çº¯å‰ç«¯è§£å†³æ–¹æ¡ˆ)

   ä¸ºäº†èƒ½è®©ä¸åŒæºä¸­çš„æ–‡æ¡£è¿›è¡Œäº¤æµï¼Œå¯ä»¥ä½¿ç”¨ [window.postMessage](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage)

8. é€šè¿‡ `websockt`, å› ä¸º `websocket` æ˜¯åŸºäº `TCP` åè®®çš„ï¼Œæ‰€ä»¥ä¸å—åŒæºç­–ç•¥çš„é™åˆ¶
